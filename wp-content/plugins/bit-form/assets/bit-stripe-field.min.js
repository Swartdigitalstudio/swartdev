var bit_stripe_field=function(){"use strict";return class{#t="";#e="";#n=null;#i=null;#s=null;#r={};#o=null;#l=null;#a=null;#c=null;#h=null;#d=null;#p=null;#y=null;#m=null;#u=null;#f=null;#g=null;#S=null;#b=null;#I=null;#v=[];constructor(t,e){this.#t="string"==typeof t?document.querySelector(t):t,Object.assign(this.#r,e),this.#e=this.#r.publishableKey,this.#n=this.#r.options,this.#i=this.#r.contentId,this.#o=this.#r.payIntegID,this.#l=this.#r.fieldKey,this.#d=this.#r?.amountFld,this.#p=this.#r?.amount,this.#h=this.#r.amountType,this.#y=this.#r.options.currency,this.#m=`#form-${this.#i}`,this.#u=this.#i?.split("_")[1],this.#S=this.#r.theme.style,this.#b=this.#r.layout,this.#I=this.#r.payBtnTxt,this.init()}init(){this.#E()}#L(t){return document.querySelector(this.#m).querySelector(t)}#E(){const t=this.#L(`.${this.#l}-stripe-btn`);this.#f=this.#L(".stripe-btn-spinner"),this.#w(t,"click",(()=>{this.#f.classList.remove("d-none"),this.#_(this.#i).then((t=>{t&&this.#K()})).finally((()=>this.#f.classList.add("d-none")))}))}#w(t,e,n){t.addEventListener(e,n),this.#v.push({selector:t,eventType:e,cb:n})}#T(t){if(t){const e=window.bf_globals[this.#i].fields[t]?.fieldName;if(!e)return;let n=this.#L(`[name="${e}"]`,this.#m);if(n&&"radio"===n.type&&(n=this.#L(`[name="${e}"]:checked`,this.#m)),n&&n.value)return n.value}return""}#$(t=""){const e=bfSelect(`${this.#m} .${this.#l}-err-wrp`),n=bfSelect(`.${this.#l}-err-txt`,e),i=bfSelect(`.${this.#l}-err-msg`,e);if(t){i.style.removeProperty("display"),n.innerHTML=t,setStyleProperty(e,"height",`${n.parentElement.scrollHeight}px`),setStyleProperty(e,"opacity",1);const s=this.#L(`${this.#m} .btcd-fld-itm.${this.#l}`);scrollToFld(s)}else n.innerHTML="",setStyleProperty(i,"display","none"),setStyleProperty(e,"height",0),setStyleProperty(e,"opacity",0)}#K(){const{Stripe:t}=window,e=this.#T(this.#d);if("dynamic"===this.#h&&!e)return void this.#$("Amount field is required");this.#$();const n=100*("fixed"===this.#h?this.#p:e);if(t){this.#c=t(this.#e);const e={payIntegID:this.#o,amount:n,currency:this.#y,metadata:{formID:this.#u,entryID:this.#s,fieldKey:this.#l},payment_method_types:this.#n.payment_method_types};bitsFetchFront(this.#i,e,"bitforms_get_stripe_secret_key").then((t=>{const{success:e,data:n}=t;if(!e)return void this.#$(n.error.message);this.#$(),this.#t.classList.remove("d-none");const{clientSecret:i}=n,s={appearance:this.#S,clientSecret:i,locale:this.#n.locale};if(this.#a=this.#c.elements(s),this.#g=this.#a.create("payment",{layout:this.#b}),this.#r?.linkAuthentication?.active){const t=this.#T(this.#r.linkAuthentication.emailFld),e=this.#a.create("linkAuthentication",{defaultValues:{email:t}}),n=this.#L(`${this.#m} .${this.#l}-stripe-auth-wrp`);e.mount(n)}if(this.#r?.address?.active){const{address:t}=this.#r,e=this.#a.create("address",t),n=this.#L(`${this.#m} .${this.#l}-stripe-addr-wrp`);e.mount(n)}this.#g.mount(this.#t),this.#f.classList.add("d-none")})).then((()=>{const t=document.createElement("button");t.innerText=this.#I,t.classList.add("stripe-pay-btn"),t.setAttribute("id","pay-now-btn"),t.setAttribute("type","button");const e=document.createElement("span");e.innerHTML='\n                <svg width="25" height="25" class="pay-spinner d-none" version="1.1" id="L9" xmlns="http://www.w3.org/2000/svg"\n                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 0 0"\n                xml:space="preserve">\n                <path fill="#fff"\n                  d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50">\n                  <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s" from="0 50 50"\n                    to="360 50 50" repeatCount="indefinite" />\n                </path>\n              </svg>',t.insertAdjacentElement("beforeend",e),this.#t.insertAdjacentElement("beforeend",t),this.#x()}))}}#x(){const t=this.#L("#pay-now-btn"),e=this.#a;this.#w(t,"click",(()=>{const t=this.#L(".pay-spinner");t.classList.remove("d-none"),this.#c.confirmPayment({elements:e,confirmParams:{},redirect:"if_required"}).then((e=>{"succeeded"===e?.paymentIntent?.status?(t.classList.add("d-none"),this.#q(e.paymentIntent),this.#g.clear()):t.classList.add("d-none")}))}))}async#_(t){try{await isFormValidatedWithoutError(t)}catch(t){return Promise.reject()}const e=await saveFormProgress(t),n=e?.[t];return n?.success?(n.entry_id&&(this.#s=n.entry_id),Promise.resolve(!0)):Promise.reject()}#q(t){const e=document.getElementById(`${this.#i}`);e.classList.add("pos-rel","form-loading");const n=document.getElementById(`form-${this.#i}`);if(null!=n){const i=bf_globals[this.#i];this.#s&&(i.entryId=this.#s);const s=bfSelect(`input[name="${this.#r.fieldKey}"]`,n);s?s.value=t.id:setHiddenFld({name:this.#r.fieldKey,value:t.id,type:"text"},n);let r=bfSelect('button[type="submit"]',n);r||(r=document.createElement("button"),r.setAttribute("type","submit"),r.style.display="none",n.append(r)),r.click();const o={formID:this.#u,transactionID:t.id,payment_name:"stripe",payment_type:"order",payment_response:t,entry_id:this.#s,fieldKey:this.#l},l=new URL(i?.ajaxURL);l.searchParams.append("_ajax_nonce",i?.nonce),l.searchParams.append("action","bitforms_payment_insert"),fetch(l,{method:"POST",body:JSON.stringify(o)}).then((()=>{e.classList.remove("pos-rel","form-loading"),this.#s=null}))}}#P(){this.#v.forEach((({selector:t,eventType:e,cb:n})=>{t.removeEventListener(e,n)}))}destroy(){this.#g?.destroy();const t=this.#L(`.${this.#l}-stripe-fld`),e=this.#L(`.${this.#l}-stripe-auth-wrp`),n=this.#L(`.${this.#l}-stripe-addr-wrp`);t.classList.add("d-none"),t.innerHTML="",this.#t.innerHTML="",e&&(e.innerHTML=""),n&&(n.innerHTML=""),this.#P()}reset(){this.destroy(),this.init()}}}();
